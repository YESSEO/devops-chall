version: '3.7'
networks:
 wazuh_default:
  driver: overlay
  attachable: true

services:
  wazuh_master:
    image: wazuh/wazuh-manager:{{ wazuh_version }}
    hostname: wazuh.master
    deploy:
      update_config:
        parallelism: 1
        delay: 10s
        failure_action: rollback
      rollback_config:
        parallelism: 1
        delay: 10s
    networks:
      wazuh_default:
        aliases:
          - wazuh.master
    restart: always
    ulimits:
      memlock:
        soft: -1
        hard: -1
      nofile:
        soft: 655360
        hard: 655360
    ports:
      - "1515:1515"
      - "514:514/udp"
      - "55000:55000"
    environment:
      - INDEXER_URL=https://wazuh1.indexer:9200
      - INDEXER_USERNAME={{ indexerusername }}
      - INDEXER_PASSWORD={{ indexerpassword }}
      - FILEBEAT_SSL_VERIFICATION_MODE=full
      - SSL_CERTIFICATE_AUTHORITIES=/etc/ssl/root-ca.pem
      - SSL_CERTIFICATE=/etc/ssl/filebeat.pem
      - SSL_KEY=/etc/ssl/filebeat.key
      - API_USERNAME={{ apiusername }}
      - API_PASSWORD={{ apipassword }}
    volumes:
      - master-wazuh-api-configuration:/var/ossec/api/configuration
      - master-wazuh-etc:/var/ossec/etc
      - master-wazuh-logs:/var/ossec/logs
      - master-wazuh-queue:/var/ossec/queue
      - master-wazuh-var-multigroups:/var/ossec/var/multigroups
      - master-wazuh-integrations:/var/ossec/integrations
      - master-wazuh-active-response:/var/ossec/active-response/bin
      - master-wazuh-agentless:/var/ossec/agentless
      - master-wazuh-wodles:/var/ossec/wodles
      - master-filebeat-etc:/etc/filebeat
      - master-filebeat-var:/var/lib/filebeat
      - "{{ nfs_mount_point }}{{ docker_wazuh_base }}/config/wazuh_indexer_ssl_certs/root-ca-manager.pem:/etc/ssl/root-ca.pem"
      - "{{ nfs_mount_point }}{{ docker_wazuh_base }}/config/wazuh_indexer_ssl_certs/wazuh.master.pem:/etc/ssl/filebeat.pem"
      - "{{ nfs_mount_point }}{{ docker_wazuh_base }}/config/wazuh_indexer_ssl_certs/wazuh.master-key.pem:/etc/ssl/filebeat.key"
      - "{{ nfs_mount_point }}{{ docker_wazuh_base }}/config/wazuh_cluster/wazuh_manager.conf:/wazuh-config-mount/etc/ossec.conf"

  wazuh_worker:
    hostname: wazuh.worker
    deploy:
      update_config:
        parallelism: 1
        delay: 10s
        failure_action: rollback
      rollback_config:
        parallelism: 1
        delay: 10s
    networks:
      wazuh_default:
        aliases:
          - wazuh.worker
    image: wazuh/wazuh-manager:{{ wazuh_version }}
    restart: always
    ulimits:
      memlock:
        soft: -1
        hard: -1
      nofile:
        soft: 655360
        hard: 655360
    environment:
      - INDEXER_URL=https://wazuh1.indexer:9200
      - INDEXER_USERNAME={{ indexerusername }}
      - INDEXER_PASSWORD={{ indexerpassword }}
      - FILEBEAT_SSL_VERIFICATION_MODE=full
      - SSL_CERTIFICATE_AUTHORITIES=/etc/ssl/root-ca.pem
      - SSL_CERTIFICATE=/etc/ssl/filebeat.pem
      - SSL_KEY=/etc/ssl/filebeat.key
    volumes:
      - worker-wazuh-api-configuration:/var/ossec/api/configuration
      - worker-wazuh-etc:/var/ossec/etc
      - worker-wazuh-logs:/var/ossec/logs
      - worker-wazuh-queue:/var/ossec/queue
      - worker-wazuh-var-multigroups:/var/ossec/var/multigroups
      - worker-wazuh-integrations:/var/ossec/integrations
      - worker-wazuh-active-response:/var/ossec/active-response/bin
      - worker-wazuh-agentless:/var/ossec/agentless
      - worker-wazuh-wodles:/var/ossec/wodles
      - worker-filebeat-etc:/etc/filebeat
      - worker-filebeat-var:/var/lib/filebeat
      - "{{ nfs_mount_point }}{{ docker_wazuh_base }}/config/wazuh_indexer_ssl_certs/root-ca-manager.pem:/etc/ssl/root-ca.pem"
      - "{{ nfs_mount_point }}{{ docker_wazuh_base }}/config/wazuh_indexer_ssl_certs/wazuh.worker.pem:/etc/ssl/filebeat.pem"
      - "{{ nfs_mount_point }}{{ docker_wazuh_base }}/config/wazuh_indexer_ssl_certs/wazuh.worker-key.pem:/etc/ssl/filebeat.key"
      - "{{ nfs_mount_point }}{{ docker_wazuh_base }}/config/wazuh_cluster/wazuh_worker.conf:/wazuh-config-mount/etc/ossec.conf"

  wazuh1_indexer:
    image: wazuh/wazuh-indexer:{{ wazuh_version }}
    hostname: wazuh1.indexer
    deploy:
      update_config:
        parallelism: 1
        delay: 10s
        failure_action: rollback
      rollback_config:
        parallelism: 1
        delay: 10s
    networks:
      wazuh_default:
        aliases:
          - wazuh1.indexer
    restart: always
    ports:
      - "9200:9200"
    environment:
      - "OPENSEARCH_JAVA_OPTS=-Xms1g -Xmx1g"
      - "bootstrap.memory_lock=true"
    ulimits:
      memlock:
        soft: -1
        hard: -1
      nofile:
        soft: 65536
        hard: 65536
    volumes:
      - wazuh-indexer-data-1:/var/lib/wazuh-indexer
      - "{{ nfs_mount_point }}{{ docker_wazuh_base }}/config/wazuh_indexer_ssl_certs/root-ca.pem:/usr/share/wazuh-indexer/certs/root-ca.pem"
      - "{{ nfs_mount_point }}{{ docker_wazuh_base }}/config/wazuh_indexer_ssl_certs/wazuh1.indexer-key.pem:/usr/share/wazuh-indexer/certs/wazuh1.indexer.key"
      - "{{ nfs_mount_point }}{{ docker_wazuh_base }}/config/wazuh_indexer_ssl_certs/wazuh1.indexer.pem:/usr/share/wazuh-indexer/certs/wazuh1.indexer.pem"
      - "{{ nfs_mount_point }}{{ docker_wazuh_base }}/config/wazuh_indexer_ssl_certs/admin.pem:/usr/share/wazuh-indexer/certs/admin.pem"
      - "{{ nfs_mount_point }}{{ docker_wazuh_base }}/config/wazuh_indexer_ssl_certs/admin-key.pem:/usr/share/wazuh-indexer/certs/admin-key.pem"
      - "{{ nfs_mount_point }}{{ docker_wazuh_base }}/config/wazuh_indexer/wazuh1.indexer.yml:/usr/share/wazuh-indexer/opensearch.yml"
      - "{{ nfs_mount_point }}{{ docker_wazuh_base }}/config/wazuh_indexer/internal_users.yml:/usr/share/wazuh-indexer/opensearch-security/internal_users.yml"

  wazuh2_indexer:
    image: wazuh/wazuh-indexer:{{ wazuh_version }}
    hostname: wazuh2.indexer
    deploy:
      update_config:
        parallelism: 1
        delay: 10s
        failure_action: rollback
      rollback_config:
        parallelism: 1
        delay: 10s
    networks:
      wazuh_default:
        aliases:
          - wazuh2.indexer
    restart: always
    environment:
      - "OPENSEARCH_JAVA_OPTS=-Xms1g -Xmx1g"
      - "bootstrap.memory_lock=true"
    ulimits:
      memlock:
        soft: -1
        hard: -1
      nofile:
        soft: 65536
        hard: 65536
    volumes:
      - wazuh-indexer-data-2:/var/lib/wazuh-indexer
      - "{{ nfs_mount_point }}{{ docker_wazuh_base }}/config/wazuh_indexer_ssl_certs/root-ca.pem:/usr/share/wazuh-indexer/certs/root-ca.pem"
      - "{{ nfs_mount_point }}{{ docker_wazuh_base }}/config/wazuh_indexer_ssl_certs/wazuh2.indexer-key.pem:/usr/share/wazuh-indexer/certs/wazuh2.indexer.key"
      - "{{ nfs_mount_point }}{{ docker_wazuh_base }}/config/wazuh_indexer_ssl_certs/wazuh2.indexer.pem:/usr/share/wazuh-indexer/certs/wazuh2.indexer.pem"
      - "{{ nfs_mount_point }}{{ docker_wazuh_base }}/config/wazuh_indexer/wazuh2.indexer.yml:/usr/share/wazuh-indexer/opensearch.yml"
      - "{{ nfs_mount_point }}{{ docker_wazuh_base }}/config/wazuh_indexer/internal_users.yml:/usr/share/wazuh-indexer/opensearch-security/internal_users.yml"

  wazuh3_indexer:
    image: wazuh/wazuh-indexer:{{ wazuh_version }}
    hostname: wazuh3.indexer
    deploy:
      update_config:
        parallelism: 1
        delay: 10s
        failure_action: rollback
      rollback_config:
        parallelism: 1
        delay: 10s
    networks:
      wazuh_default:
        aliases:
          - wazuh3.indexer
    restart: always
    environment:
      - "OPENSEARCH_JAVA_OPTS=-Xms1g -Xmx1g"
      - "bootstrap.memory_lock=true"
    ulimits:
      memlock:
        soft: -1
        hard: -1
      nofile:
        soft: 65536
        hard: 65536
    volumes:
      - wazuh-indexer-data-3:/var/lib/wazuh-indexer
      - "{{ nfs_mount_point }}{{ docker_wazuh_base }}/config/wazuh_indexer_ssl_certs/root-ca.pem:/usr/share/wazuh-indexer/certs/root-ca.pem"
      - "{{ nfs_mount_point }}{{ docker_wazuh_base }}/config/wazuh_indexer_ssl_certs/wazuh3.indexer-key.pem:/usr/share/wazuh-indexer/certs/wazuh3.indexer.key"
      - "{{ nfs_mount_point }}{{ docker_wazuh_base }}/config/wazuh_indexer_ssl_certs/wazuh3.indexer.pem:/usr/share/wazuh-indexer/certs/wazuh3.indexer.pem"
      - "{{ nfs_mount_point }}{{ docker_wazuh_base }}/config/wazuh_indexer/wazuh3.indexer.yml:/usr/share/wazuh-indexer/opensearch.yml"
      - "{{ nfs_mount_point }}{{ docker_wazuh_base }}/config/wazuh_indexer/internal_users.yml:/usr/share/wazuh-indexer/opensearch-security/internal_users.yml"

  wazuh_dashboard:
    image: wazuh/wazuh-dashboard:{{ wazuh_version }}
    hostname: wazuh_dashboard
    deploy:
      update_config:
        parallelism: 1
        delay: 10s
        failure_action: rollback
      rollback_config:
        parallelism: 1
        delay: 10s
    networks:
      wazuh_default:
        aliases:
          - wazuh.dashboard
    restart: always
    ports:
      - 127.0.0.1:8443:5601
    environment:
      - OPENSEARCH_HOSTS="https://wazuh1.indexer:9200"
      - WAZUH_API_URL="https://wazuh.master"
      - API_USERNAME={{ apiusername }}
      - API_PASSWORD={{ apipassword }}
      # Kibana Server
      - DASHBOARD_USERNAME={{ dashboardusername }}
      - DASHBOARD_PASSWORD={{ dashboardpassowrd }}
    volumes:
      - "{{ nfs_mount_point }}{{ docker_wazuh_base }}/config/wazuh_indexer_ssl_certs/wazuh.dashboard.pem:/usr/share/wazuh-dashboard/certs/wazuh-dashboard.pem"
      - "{{ nfs_mount_point }}{{ docker_wazuh_base }}/config/wazuh_indexer_ssl_certs/wazuh.dashboard-key.pem:/usr/share/wazuh-dashboard/certs/wazuh-dashboard-key.pem"
      - "{{ nfs_mount_point }}{{ docker_wazuh_base }}/config/wazuh_indexer_ssl_certs/root-ca.pem:/usr/share/wazuh-dashboard/certs/root-ca.pem"
      - "{{ nfs_mount_point }}{{ docker_wazuh_base }}/config/wazuh_dashboard/opensearch_dashboards.yml:/usr/share/wazuh-dashboard/config/opensearch_dashboards.yml"
      - "{{ nfs_mount_point }}{{ docker_wazuh_base }}/config/wazuh_dashboard/wazuh.yml:/usr/share/wazuh-dashboard/data/wazuh/config/wazuh.yml"
      - wazuh-dashboard-config:/usr/share/wazuh-dashboard/data/wazuh/config
      - wazuh-dashboard-custom:/usr/share/wazuh-dashboard/plugins/wazuh/public/assets/custom
    depends_on:
      - wazuh1.indexer
    links:
      - wazuh1.indexer:wazuh1.indexer
      - wazuh.master:wazuh.master

  nginx:
    image: nginx:stable
    hostname: nginx
    deploy:
      update_config:
        parallelism: 1
        delay: 10s
        failure_action: rollback
      rollback_config:
        parallelism: 1
        delay: 10s
    networks:
      - wazuh_default
    restart: always
    ports:
      - "1514:1514"
    depends_on:
      - wazuh.master
      - wazuh.worker
      - wazuh.dashboard
    links:
      - wazuh.master:wazuh.master
      - wazuh.worker:wazuh.worker
      - wazuh.dashboard:wazuh.dashboard
    volumes:
      - "{{ nfs_mount_point }}{{ docker_wazuh_base }}/config/nginx/nginx.conf:/etc/nginx/nginx.conf:ro"

volumes:
  master-wazuh-api-configuration:
    driver: local
    driver_opts:
      type: "nfs"
      o: "addr={{ nfsserverip }},rw,nfsvers=4"
      device: ":{{ nfs_mount_point }}/wazuh/master/api/configuration"

  master-wazuh-etc:
    driver: local
    driver_opts:
      type: "nfs"
      o: "addr={{ nfsserverip }},rw,nfsvers=4"
      device: ":{{ nfs_mount_point }}/wazuh/master/etc"

  master-wazuh-logs:
    driver: local
    driver_opts:
      type: "nfs"
      o: "addr={{ nfsserverip }},rw,nfsvers=4"
      device: ":{{ nfs_mount_point }}/wazuh/master/logs"

  master-wazuh-queue:
    driver: local
    driver_opts:
      type: "nfs"
      o: "addr={{ nfsserverip }},rw,nfsvers=4"
      device: ":{{ nfs_mount_point }}/wazuh/master/queue"

  master-wazuh-var-multigroups:
    driver: local
    driver_opts:
      type: "nfs"
      o: "addr={{ nfsserverip }},rw,nfsvers=4"
      device: ":{{ nfs_mount_point }}/wazuh/master/var-multigroups"

  master-wazuh-integrations:
    driver: local
    driver_opts:
      type: "nfs"
      o: "addr={{ nfsserverip }},rw,nfsvers=4"
      device: ":{{ nfs_mount_point }}/wazuh/master/integrations"

  master-wazuh-active-response:
    driver: local
    driver_opts:
      type: "nfs"
      o: "addr={{ nfsserverip }},rw,nfsvers=4"
      device: ":{{ nfs_mount_point }}/wazuh/master/active-response"

  master-wazuh-agentless:
    driver: local
    driver_opts:
      type: "nfs"
      o: "addr={{ nfsserverip }},rw,nfsvers=4"
      device: ":{{ nfs_mount_point }}/wazuh/master/agentless"

  master-wazuh-wodles:
    driver: local
    driver_opts:
      type: "nfs"
      o: "addr={{ nfsserverip }},rw,nfsvers=4"
      device: ":{{ nfs_mount_point }}/wazuh/master/wodles"

  master-filebeat-etc:
    driver: local
    driver_opts:
      type: "nfs"
      o: "addr={{ nfsserverip }},rw,nfsvers=4"
      device: ":{{ nfs_mount_point }}/wazuh/master/filebeat-etc"

  master-filebeat-var:
    driver: local
    driver_opts:
      type: "nfs"
      o: "addr={{ nfsserverip }},rw,nfsvers=4"
      device: ":{{ nfs_mount_point }}/wazuh/master/filebeat-var"


  worker-wazuh-api-configuration:
    driver: local
    driver_opts:
      type: "nfs"
      o: "addr={{ nfsserverip }},rw,nfsvers=4"
      device: ":{{ nfs_mount_point }}/wazuh/worker/api/configuration"

  worker-wazuh-etc:
    driver: local
    driver_opts:
      type: "nfs"
      o: "addr={{ nfsserverip }},rw,nfsvers=4"
      device: ":{{ nfs_mount_point }}/wazuh/worker/etc"

  worker-wazuh-logs:
    driver: local
    driver_opts:
      type: "nfs"
      o: "addr={{ nfsserverip }},rw,nfsvers=4"
      device: ":{{ nfs_mount_point }}/wazuh/worker/logs"

  worker-wazuh-queue:
    driver: local
    driver_opts:
      type: "nfs"
      o: "addr={{ nfsserverip }},rw,nfsvers=4"
      device: ":{{ nfs_mount_point }}/wazuh/worker/queue"

  worker-wazuh-var-multigroups:
    driver: local
    driver_opts:
      type: "nfs"
      o: "addr={{ nfsserverip }},rw,nfsvers=4"
      device: ":{{ nfs_mount_point }}/wazuh/worker/var-multigroups"

  worker-wazuh-integrations:
    driver: local
    driver_opts:
      type: "nfs"
      o: "addr={{ nfsserverip }},rw,nfsvers=4"
      device: ":{{ nfs_mount_point }}/wazuh/worker/integrations"

  worker-wazuh-active-response:
    driver: local
    driver_opts:
      type: "nfs"
      o: "addr={{ nfsserverip }},rw,nfsvers=4"
      device: ":{{ nfs_mount_point }}/wazuh/worker/active-response"

  worker-wazuh-agentless:
    driver: local
    driver_opts:
      type: "nfs"
      o: "addr={{ nfsserverip }},rw,nfsvers=4"
      device: ":{{ nfs_mount_point }}/wazuh/worker/agentless"

  worker-wazuh-wodles:
    driver: local
    driver_opts:
      type: "nfs"
      o: "addr={{ nfsserverip }},rw,nfsvers=4"
      device: ":{{ nfs_mount_point }}/wazuh/worker/wodles"

  worker-filebeat-etc:
    driver: local
    driver_opts:
      type: "nfs"
      o: "addr={{ nfsserverip }},rw,nfsvers=4"
      device: ":{{ nfs_mount_point }}/wazuh/worker/filebeat-etc"

  worker-filebeat-var:
    driver: local
    driver_opts:
      type: "nfs"
      o: "addr={{ nfsserverip }},rw,nfsvers=4"
      device: ":{{ nfs_mount_point }}/wazuh/worker/filebeat-var"

  wazuh-indexer-data-1:
    driver: local
    driver_opts:
      type: "nfs"
      o: "addr={{ nfsserverip }},rw,nfsvers=4"
      device: ":{{ nfs_mount_point }}/wazuh/indexer1"

  wazuh-indexer-data-2:
    driver: local
    driver_opts:
      type: "nfs"
      o: "addr={{ nfsserverip }},rw,nfsvers=4"
      device: ":{{ nfs_mount_point }}/wazuh/indexer2"

  wazuh-indexer-data-3:
    driver: local
    driver_opts:
      type: "nfs"
      o: "addr={{ nfsserverip }},rw,nfsvers=4"
      device: ":{{ nfs_mount_point }}/wazuh/indexer3"

  wazuh-dashboard-config:
    driver: local
    driver_opts:
      type: "nfs"
      o: "addr={{ nfsserverip }},rw,nfsvers=4"
      device: ":{{ nfs_mount_point }}/wazuh/dashboard/config"

  wazuh-dashboard-custom:
    driver: local
    driver_opts:
      type: "nfs"
      o: "addr={{ nfsserverip }},rw,nfsvers=4"
      device: ":{{ nfs_mount_point }}/wazuh/dashboard/custom"
